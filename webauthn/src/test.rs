use crate::contract::*;
use cosmwasm_std::{
    from_binary,
    testing::{mock_dependencies, mock_env},
    Binary,
};
use sylvia::types::QueryCtx;
use vectis_wallet::{interface::AuthenticatorTrait, types::wallet::WebauthnRelayedTxMsg};

const PUB_KEY_BYTES: [u8; 65] = [
    4, 254, 213, 81, 121, 242, 209, 178, 171, 160, 209, 220, 243, 199, 156, 57, 7, 187, 116, 219,
    198, 101, 89, 52, 55, 116, 76, 44, 30, 67, 0, 143, 189, 75, 244, 25, 219, 51, 204, 90, 94, 118,
    253, 230, 111, 25, 66, 150, 185, 16, 177, 143, 185, 58, 174, 105, 199, 187, 209, 50, 112, 128,
    88, 201, 199,
];

const COSMOS_MSG: [u8; 147] = [
    123, 34, 109, 101, 115, 115, 97, 103, 101, 115, 34, 58, 91, 123, 34, 98, 97, 110, 107, 34, 58,
    123, 34, 115, 101, 110, 100, 34, 58, 123, 34, 97, 109, 111, 117, 110, 116, 34, 58, 91, 123, 34,
    100, 101, 110, 111, 109, 34, 58, 34, 117, 106, 117, 110, 111, 120, 34, 44, 34, 97, 109, 111,
    117, 110, 116, 34, 58, 34, 49, 48, 34, 125, 93, 44, 34, 116, 111, 95, 97, 100, 100, 114, 101,
    115, 115, 34, 58, 34, 106, 117, 110, 111, 49, 113, 99, 54, 99, 113, 50, 108, 115, 100, 48, 118,
    99, 99, 99, 101, 117, 112, 115, 55, 51, 97, 117, 100, 100, 116, 117, 50, 112, 54, 112, 121,
    109, 119, 100, 54, 117, 115, 104, 34, 125, 125, 125, 93, 44, 34, 110, 111, 110, 99, 101, 34,
    58, 48, 125,
];

const CLIENT_DATA: [u8; 143] = [
    123, 34, 116, 121, 112, 101, 34, 58, 34, 119, 101, 98, 97, 117, 116, 104, 110, 46, 103, 101,
    116, 34, 44, 34, 99, 104, 97, 108, 108, 101, 110, 103, 101, 34, 58, 34, 90, 71, 87, 84, 81, 66,
    48, 116, 116, 81, 72, 112, 114, 83, 68, 121, 117, 121, 97, 118, 81, 118, 70, 76, 107, 116, 79,
    77, 109, 97, 85, 97, 121, 85, 103, 112, 52, 112, 97, 77, 72, 122, 107, 34, 44, 34, 111, 114,
    105, 103, 105, 110, 34, 58, 34, 104, 116, 116, 112, 115, 58, 47, 47, 112, 97, 115, 115, 107,
    101, 121, 45, 112, 111, 99, 46, 118, 101, 114, 99, 101, 108, 46, 97, 112, 112, 34, 44, 34, 99,
    114, 111, 115, 115, 79, 114, 105, 103, 105, 110, 34, 58, 102, 97, 108, 115, 101, 125,
];

const AUTH_DATA: [u8; 37] = [
    160, 69, 228, 49, 29, 7, 49, 76, 44, 221, 70, 108, 153, 137, 118, 53, 175, 165, 26, 158, 250,
    12, 31, 58, 208, 251, 254, 192, 151, 172, 43, 29, 1, 0, 0, 0, 0,
];

const ASN1SIG: [u8; 72] = [
    48, 70, 2, 33, 0, 239, 139, 59, 204, 38, 219, 76, 13, 81, 227, 244, 206, 106, 106, 82, 233,
    224, 66, 106, 231, 148, 119, 165, 59, 129, 5, 37, 86, 23, 26, 127, 230, 2, 33, 0, 245, 7, 2,
    167, 86, 219, 132, 126, 6, 203, 61, 98, 248, 2, 14, 132, 111, 193, 212, 143, 212, 201, 248,
    197, 239, 30, 189, 97, 112, 61, 42, 195,
];

const WEB_MSG: [u8; 305] = [
    123, 34, 97, 117, 116, 104, 95, 100, 97, 116, 97, 34, 58, 34, 111, 69, 88, 107, 77, 82, 48, 72,
    77, 85, 119, 115, 51, 85, 90, 115, 109, 89, 108, 50, 78, 97, 43, 108, 71, 112, 55, 54, 68, 66,
    56, 54, 48, 80, 118, 43, 119, 74, 101, 115, 75, 120, 48, 66, 65, 65, 65, 65, 65, 65, 61, 61,
    34, 44, 34, 99, 108, 105, 101, 110, 116, 95, 100, 97, 116, 97, 34, 58, 34, 101, 121, 74, 48,
    101, 88, 66, 108, 73, 106, 111, 105, 100, 50, 86, 105, 89, 88, 86, 48, 97, 71, 52, 117, 90, 50,
    86, 48, 73, 105, 119, 105, 89, 50, 104, 104, 98, 71, 120, 108, 98, 109, 100, 108, 73, 106, 111,
    105, 87, 107, 100, 88, 86, 70, 70, 67, 77, 72, 82, 48, 85, 85, 104, 119, 99, 108, 78, 69, 101,
    88, 86, 53, 89, 88, 90, 82, 100, 107, 90, 77, 97, 51, 82, 80, 84, 87, 49, 104, 86, 87, 70, 53,
    86, 87, 100, 119, 78, 72, 66, 104, 84, 85, 104, 54, 97, 121, 73, 115, 73, 109, 57, 121, 97, 87,
    100, 112, 98, 105, 73, 54, 73, 109, 104, 48, 100, 72, 66, 122, 79, 105, 56, 118, 99, 71, 70,
    122, 99, 50, 116, 108, 101, 83, 49, 119, 98, 50, 77, 117, 100, 109, 86, 121, 89, 50, 86, 115,
    76, 109, 70, 119, 99, 67, 73, 115, 73, 109, 78, 121, 98, 51, 78, 122, 84, 51, 74, 112, 90, 50,
    108, 117, 73, 106, 112, 109, 89, 87, 120, 122, 90, 88, 48, 61, 34, 44, 34, 115, 105, 103, 110,
    101, 100, 95, 100, 97, 116, 97, 34, 58, 34, 115, 111, 109, 101, 45, 115, 116, 114, 105, 110,
    103, 34, 125,
];

fn get_controller_data() -> Vec<u8> {
    PUB_KEY_BYTES.to_vec()
}

#[test]
fn it_can_read_webauthn_msg() {
    let res: WebauthnRelayedTxMsg = from_binary(&Binary(WEB_MSG.to_vec())).unwrap();
    println!("res: {:?}", res);
}

#[test]
fn it_de_client_data_correctly() {
    let client_data = de_client_data(&CLIENT_DATA).unwrap();
    let challenge = client_data.challenge;
    assert_eq!(challenge, hash_to_base64url_string(&COSMOS_MSG))
}

#[test]
fn it_verifies() {
    let contract = Webauthn::new();
    let deps = mock_dependencies();
    let ctx = QueryCtx {
        deps: deps.as_ref(),
        env: mock_env(),
    };
    let result = contract
        .authenticate(
            ctx,
            COSMOS_MSG.to_vec(),
            get_controller_data(),
            vec![AUTH_DATA.to_vec(), CLIENT_DATA.to_vec()],
            ASN1SIG.to_vec(),
        )
        .unwrap();
    assert_eq!(result, true)
}

#[test]
fn it_does_not_verify_wrong_auth_data() {
    let contract = Webauthn::new();
    let deps = mock_dependencies();
    let ctx = QueryCtx {
        deps: deps.as_ref(),
        env: mock_env(),
    };

    let mut wrong_hash = AUTH_DATA.to_vec();
    wrong_hash.swap(15, 18);

    let result = contract
        .authenticate(
            ctx,
            COSMOS_MSG.to_vec(),
            get_controller_data(),
            vec![wrong_hash, CLIENT_DATA.to_vec()],
            ASN1SIG.to_vec(),
        )
        .unwrap();
    assert_eq!(result, false)
}
